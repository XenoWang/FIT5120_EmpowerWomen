{% extends 'base.html' %}

{% block title %}Company Data - EmpowerWomen{% endblock %}

{% block content %}

<div class="container_background_6">
    <div class="companydata-title">Help you find the company that best<br> matches your career goals</div>

    <!-- Search bar container -->
    <div class="search-container">
        <form id="search-form">
            <!-- Input field for search query -->
            <input type="text" id="search-input" name="search_query" placeholder="Search...">
            <!-- Button to trigger the search -->
            <button type="submit" id="search-button">Search</button>
        </form>
    </div>
    <script src="script.js"></script>
</div>

<div class="container">
    <!-- Explore Companies Title and Subtitle (Outside the container background) -->
    <div class="explore-title">
        Explore Companies for {{ Section }}: <span id="user-input"></span> <!-- Placeholder for user input -->
    </div>
    <div class="explore-subtitle">
        Use our powerful search tool to explore company metrics, family-friendly policies, and long-term growth opportunities.
    </div>

    <!-- New container for search results -->
    <div class="search-results-container">
        <div id="search-results"></div> <!-- This div will display the search results -->
    </div>
</div>

<script>
    // Function to display companies in the search-results container
    function displayCompanies(data) {
        const resultsContainer = document.getElementById('search-results');
        resultsContainer.innerHTML = '';  // Clear previous results

        if (data.error) {
            // If there's an error (e.g., no results), show a message
            resultsContainer.innerHTML = `<p>${data.error}</p>`;
            return;
        }

        // Loop through the companies in the response
        for (const company in data) {
            if (data.hasOwnProperty(company)) {
                // Create a container for each company
                const companyDiv = document.createElement('div');
                companyDiv.classList.add('company-result');
                companyDiv.innerHTML = `<h3>${company}</h3>`;

                // Create a list for the categories and scores
                const categoryList = document.createElement('ul');

                data[company].forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<strong>${item.category}</strong>: ${item.final_score}`;
                    categoryList.appendChild(listItem);
                });

                // Append the list to the company container
                companyDiv.appendChild(categoryList);

                // Append the company container to the results container
                resultsContainer.appendChild(companyDiv);
            }
        }
    }

    // Fetch top 15 companies when the page is loaded
    window.onload = function() {
        fetch('/searchdata/top15', {
            method: 'GET'  // Use GET to retrieve the top 15 companies
        })
        .then(response => response.json())  // Convert the server response to JSON
        .then(data => {
            displayCompanies(data);  // Display the top 15 companies
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('search-results').innerHTML = '<p>There was an error loading the top companies.</p>';
        });
    };

    // Attach an event listener to the form to handle submission
    document.getElementById('search-form').addEventListener('submit', function (event) {
        event.preventDefault();  // Prevent the default form submission (page reload)

        // Get the search input value entered by the user
        const searchQuery = document.getElementById('search-input').value;

        // Dynamically update the title with the user input
        document.getElementById('user-input').textContent = searchQuery;

        // Use fetch to send an AJAX POST request to the server
        fetch('/searchdata', {
            method: 'POST',  // Use POST to send the search query
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'  // Set the request headers
            },
            body: `search_query=${encodeURIComponent(searchQuery)}`  // Encode and send the search query
        })
        .then(response => response.json())  // Convert the server response to JSON
        .then(data => {
            displayCompanies(data);  // Display the search results
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('search-results').innerHTML = '<p>There was an error processing your request.</p>';
        });
    });
</script>

{% endblock %}
